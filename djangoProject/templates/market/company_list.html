<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Companies</title>
  {% load static %}
  <!-- Load a modern font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f4f7f9;
      margin: 0;
      padding: 20px;
    }
    nav {
      background: #007BFF;
      padding: 10px;
      text-align: center;
      margin-bottom: 20px;
    }
    nav a {
      color: #fff;
      margin: 0 10px;
      text-decoration: none;
      font-weight: 500;
    }
    nav a:hover {
      text-decoration: underline;
    }
    .container {
      max-width: 1200px;
      margin: auto;
    }
    .company-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
    }
    .company-info {
      flex: 1;
      min-width: 300px;
      padding: 10px;
    }
    .company-info h2 {
      margin: 0;
      color: #333;
    }
    .company-info p {
      margin: 5px 0;
      color: #555;
    }
    .company-chart {
      flex: 1;
      min-width: 300px;
      padding: 10px;
    }
    .view-details {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 16px;
      background: #007BFF;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
    }
    .view-details:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav>
    <a href="{% url 'home' %}">Home</a>
    <a href="{% url 'market:market_home' %}">Sustainable Market</a>
    <a href="{% url 'market:portfolio' %}">My Portfolio</a>
    <a href="{% url 'market:market_events' %}">Market Events</a>
    <a href="{% url 'market:leaderboard' %}">Leaderboard</a>
    {% if user.is_authenticated %}
      <span class="balance">Balance: ${{ user.userprofile.currency_balance }}</span>
      <a href="{% url 'users:profile' %}">Profile</a>
      <a href="{% url 'users:logout' %}">Logout</a>
    {% else %}
      <a href="{% url 'users:login' %}">Login</a>
      <a href="{% url 'users:signup' %}">Signup</a>
    {% endif %}
  </nav>

  <div class="container">
    <h1>Companies</h1>
    {% for company in companies %}
      <div class="company-card">
        <div class="company-info">
          <h2>{{ company.name }}</h2>
          <p>{{ company.description|truncatewords:25 }}</p>
          <p><strong>Sustainability Rating:</strong> {{ company.sustainability_rating }}</p>
          <p><strong>Current Stock Price:</strong> ${{ company.current_stock_price }}</p>
          <a class="view-details" href="{% url 'market:company_detail' company.pk %}">View Details</a>
        </div>
        <div class="company-chart">
          <canvas id="chart-{{ company.id }}" width="300" height="200"></canvas>
        </div>
      </div>
    {% empty %}
      <p>No companies available.</p>
    {% endfor %}
  </div>

  <!-- Load Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // For each company, fetch historical price data and draw a mini chart.
    document.addEventListener("DOMContentLoaded", function() {
      {% for company in companies %}
        (function(){
          const companyId = {{ company.id }};
          const canvasId = "chart-" + companyId;
          fetch("{% url 'market:price_history_api' company.id %}")
            .then(response => response.json())
            .then(data => {
              const dates = data.history.map(item => item.date);
              const prices = data.history.map(item => parseFloat(item.price));
              const ctx = document.getElementById(canvasId).getContext('2d');
              new Chart(ctx, {
                type: 'line',
                data: {
                  labels: dates,
                  datasets: [{
                    label: '',
                    data: prices,
                    borderColor: 'rgba(0, 123, 255, 1)',
                    backgroundColor: 'rgba(0, 123, 255, 0.2)',
                    borderWidth: 1,
                    fill: true,
                    tension: 0.3
                  }]
                },
                options: {
                  responsive: false,
                  maintainAspectRatio: false,
                  scales: {
                    x: { display: false },
                    y: { display: false }
                  },
                  plugins: {
                    legend: { display: false }
                  }
                }
              });
            })
            .catch(error => console.error('Error fetching price history for company ' + companyId, error));
        })();
      {% endfor %}
    });
  </script>
</body>
</html>